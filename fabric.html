<!DOCTYPE html>
<html>
<head>
  <title>Fabric.js SVG Canvas Example</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
    }
    #canvas-container {
      border: 1px solid #ccc;
      margin: 20px;
    }
  </style>
</head>
<body>

  <h1>Fabric.js SVG Canvas Example</h1>

  <div id="canvas-container">
    <canvas id="myCanvas" width="900" height="400"></canvas>
  </div>

  <script>
    const canvas = new fabric.Canvas('myCanvas');

    // Load the SVG elements
    const svgString = `
      <svg width="600" height="400" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <rect x="50" y="50" width="100" height="80" fill="lightblue" id="myRect"/>
        <image x="200" y="50" width="100" height="80" xlink:href="https://www.svgrepo.com/show/493144/image.svg" id="myImage"/>
        <g id="myArrow">
          <line x1="350" y1="70" x2="450" y2="70" stroke="green" stroke-width="5" id="arrowTail"/>
          <polygon points="450,60 470,70 450,80" fill="green" id="arrowHead"/>
        </g>
      </svg>
    `;

    fabric.loadSVGFromString(svgString, (objects, options) => {
        console.log("Loaded Objects:", objects); // DEBUG: Inspect the loaded objects

        // Access SVG elements by their IDs and create Fabric.js objects
        const rectElement = objects.find(obj => obj.id === 'myRect');
        const imageElement = objects.find(obj => obj.id === 'myImage');
        const arrowTailElement = objects.find(obj => obj.id === 'arrowTail');
        const arrowHeadElement = objects.find(obj => obj.id === 'arrowHead');

        console.log("Rect Element:", rectElement);    //DEBUG
        console.log("Image Element:", imageElement);  //DEBUG
        console.log("Arrow Tail:", arrowTailElement);  //DEBUG
        console.log("Arrow Head:", arrowHeadElement);  //DEBUG


        if (!imageElement) {
            console.error("Error: Could not find image element with ID 'myImage'");
            return; // Exit if image element is not found.
        }



        // Create Fabric.js objects
        const rect = new fabric.Rect({
            left: rectElement.left || parseInt(rectElement.x),
            top: rectElement.top || parseInt(rectElement.y),
            width: rectElement.width || parseInt(rectElement.width),
            height: rectElement.height || parseInt(rectElement.height),
            fill: rectElement.fill,
            originX: 'left',
            originY: 'top',
        });

        // Correct Fabric.Image creation (using the actual element)
        const image = new fabric.Image(imageElement._element, {
            left: imageElement.left || parseInt(imageElement.x),
            top: imageElement.top || parseInt(imageElement.y),
            width: imageElement.width || parseInt(imageElement.width),
            height: imageElement.height || parseInt(imageElement.height),
            originX: 'left',
            originY: 'top'
        });

        const arrowTail = new fabric.Line([parseInt(arrowTailElement.x1), parseInt(arrowTailElement.y1), parseInt(arrowTailElement.x2), parseInt(arrowTailElement.y2)], {
            stroke: arrowTailElement.stroke,
            strokeWidth: arrowTailElement['stroke-width'] || parseInt(arrowTailElement.strokeWidth),
            originX: 'left',
            originY: 'top',
        });

        const arrowHead = new fabric.Polygon(arrowHeadElement.points, {
            fill: arrowHeadElement.fill,
            originX: 'left',
            originY: 'top',
        });


        // Group the arrow elements
        const arrowGroup = new fabric.Group([arrowTail, arrowHead], {
            left: arrowTailElement.left || Math.min(parseInt(arrowTailElement.x1), parseInt(arrowTailElement.x2)),
            top: arrowTailElement.top || Math.min(parseInt(arrowTailElement.y1), parseInt(arrowTailElement.y2)),
            originX: 'left',
            originY: 'top'
        });

        // Add the objects to the canvas
        canvas.add(rect);
        canvas.add(image);
        canvas.add(arrowGroup);

        // Set the canvas to be selectable and resizable by default.
        canvas.selection = true;
        canvas.forEachObject(function (obj) {
            obj.set({
                hasControls: true,
                hasBorders: true,
                selectable: true,
            });
        });

        canvas.renderAll();  //Important to refresh the canvas

    });


  </script>

</body>
</html>